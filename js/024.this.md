## this

### bind apply call
#### åŒºåˆ«

### é»˜è®¤ç»‘å®šï¼ˆå‡½æ•°ç›´æ¥è°ƒç”¨ï¼‰

> 1. éä¸¥æ ¼æ¨¡å¼ä¸‹ï¼Œé»˜è®¤ç»‘å®šæŒ‡å‘å…¨å±€ï¼ˆ`node` ä¸­æ˜¯ `global`ï¼‰

### éšå¼ç»‘å®šï¼ˆå±æ€§è®¿é—®è°ƒç”¨ï¼‰

> éšå¼ç»‘å®šçš„ `this` æŒ‡çš„æ˜¯è°ƒç”¨å †æ ˆçš„ **ä¸Šä¸€çº§**ï¼ˆ`.` å‰é¢ä¸€ä¸ªï¼‰


é¢è¯•å®˜ä¸€èˆ¬é—®çš„æ˜¯ä¸€äº›è¾¹ç•Œ `case`ï¼Œæ¯”å¦‚éšå¼ç»‘å®šå¤±æ•ˆï¼ˆåˆ—ä¸¾éƒ¨åˆ†ï¼‰ï¼š

```js
// ç¬¬ä¸€ç§
const obj1 = {
  a: 1,
  fn: function() {
    console.log(this.a)
  }
}

const fn1 = obj1.fn // å°†å¼•ç”¨ç»™äº† fn1ï¼Œç­‰åŒäºå†™äº† function fn1() { console.log(this.a) }
fn1() // æ‰€ä»¥è¿™é‡Œå…¶å®å·²ç»å˜æˆäº†é»˜è®¤ç»‘å®šè§„åˆ™äº†ï¼Œè¯¥å‡½æ•° `fn1` æ‰§è¡Œçš„ç¯å¢ƒå°±æ˜¯å…¨å±€ç¯å¢ƒ

// ç¬¬äºŒç§ setTimeout
setTimeout(obj1.fn, 1000) // è¿™é‡Œæ‰§è¡Œçš„ç¯å¢ƒåŒæ ·æ˜¯å…¨å±€

// ç¬¬ä¸‰ç§ å‡½æ•°ä½œä¸ºå‚æ•°ä¼ é€’
function run(fn) {
  fn()
}
run(obj1.fn) // è¿™é‡Œä¼ è¿›å»çš„æ˜¯ä¸€ä¸ªå¼•ç”¨ â­

// ç¬¬å››ç§ ä¸€èˆ¬åŒ¿åå‡½æ•°ä¹Ÿæ˜¯ä¼šæŒ‡å‘å…¨å±€çš„
var name = 'The Window';
var obj = {
    name: 'My obj',
    getName: function() {
      console.log('first',this)
        return function() { // è¿™æ˜¯ä¸€ä¸ªåŒ¿åå‡½æ•°
        console.log('second', this)
            console.log(this.name)
        };
    }
}
obj.getName()()

// ç¬¬äº”ç§ å‡½æ•°èµ‹å€¼ä¹Ÿä¼šæ”¹å˜ this æŒ‡å‘ï¼Œä¸‹è¾¹ç»ƒä¹ é¢˜ä¼šæœ‰ caseï¼Œreact ä¸­äº‹ä»¶å¤„ç†å‡½æ•°ä¸ºå•¥è¦ bind ä¸€ä¸‹çš„åŸå› 
// ç¬¬å…­ç§ IIFE
```

### æ˜¾å¼ç»‘å®šï¼ˆ`call`, `apply`, `bind`ï¼‰

é€šè¿‡æ˜¾å¼çš„ä¸€äº›æ–¹æ³•å»å¼ºè¡Œçš„ç»‘å®š `this` ä¸Šä¸‹æ–‡

```js
function fn () {
  console.log(this.a)
}

const obj = {
  a: 100
}

fn.call(obj) // console what ?
```



> TIP ğŸ‘‰ è¿™ç§æ ¹æœ¬è¿˜æ˜¯å–å†³äºç¬¬ä¸€ä¸ªå‚æ•°
>
> ä½†æ˜¯ç¬¬ä¸€ä¸ªä¸º `null` çš„æ—¶å€™è¿˜æ˜¯ç»‘åˆ°å…¨å±€çš„


bind
```js
function fn() {
  console.log(this)
}

// ä¸ºå•¥å¯ä»¥ç»‘å®šåŸºæœ¬ç±»å‹ ?
// boxing(è£…ç®±) -> (1 ----> Number(1))
// bind åªçœ‹ç¬¬ä¸€ä¸ª bindï¼ˆå †æ ˆçš„ä¸Šä¸‹æ–‡ï¼Œä¸Šä¸€ä¸ªï¼Œå†™çš„é¡ºåºæ¥çœ‹å°±æ˜¯ç¬¬ä¸€ä¸ªï¼‰
fn.bind(1).bind(2)() // console what ?
```

çœ‹çœ‹å®ç°ä¹Ÿå¾ˆæœ‰è¶£ï¼ˆ`FROM MDN`ï¼‰ï¼š

```js
//  Yes, it does work with `new (funcA.bind(thisArg, args))`
if (!Function.prototype.bind) (function(){
  var ArrayPrototypeSlice = Array.prototype.slice; // ä¸ºäº† this
  Function.prototype.bind = function(otherThis) {
    // è°ƒç”¨è€…å¿…é¡»æ˜¯å‡½æ•°ï¼Œè¿™é‡Œçš„ this æŒ‡å‘è°ƒç”¨è€…ï¼šfn.bind(ctx, ...args) / fn
    if (typeof this !== 'function') {
      // closest thing possible to the ECMAScript 5
      // internal IsCallable function
      throw new TypeError('Function.prototype.bind - what is trying to be bound is not callable');
    }

    var baseArgs= ArrayPrototypeSlice.call(arguments, 1), // å–ä½™ä¸‹çš„å‚æ•°
        baseArgsLength = baseArgs.length,
        fToBind = this, // è°ƒç”¨è€…
        fNOP    = function() {}, // å¯„ç”Ÿç»„åˆé›†æˆéœ€è¦ä¸€ä¸ªä¸­é—´å‡½æ•°ï¼Œé¿å…ä¸¤æ¬¡æ„é€ 
        fBound  = function() {
          // const newFn = fn.bind(ctx, 1); newFn(2) -> arguments: [1, 2]
          baseArgs.length = baseArgsLength; // reset to default base arguments
          baseArgs.push.apply(baseArgs, arguments); // å‚æ•°æ”¶é›†
          return fToBind.apply( // apply æ˜¾ç¤ºç»‘å®š this
            // åˆ¤æ–­æ˜¯ä¸æ˜¯ new è°ƒç”¨çš„æƒ…å†µï¼Œè¿™é‡Œä¹Ÿè¯´æ˜äº†åè¾¹è¦è®²çš„ä¼˜å…ˆçº§é—®é¢˜      
            fNOP.prototype.isPrototypeOf(this) ? this : otherThis, baseArgs
          );
        };
		// ä¸‹è¾¹æ˜¯ä¸ºäº†å®ç°åŸå‹ç»§æ‰¿
    if (this.prototype) { // å‡½æ•°çš„åŸå‹æŒ‡å‘å…¶æ„é€ å‡½æ•°ï¼Œæ„é€ å‡½æ•°çš„åŸå‹æŒ‡å‘å‡½æ•°
      // Function.prototype doesn't have a prototype property
      fNOP.prototype = this.prototype; // å°±æ˜¯è®©ä¸­é—´å‡½æ•°çš„æ„é€ å‡½æ•°æŒ‡å‘è°ƒç”¨è€…çš„æ„é€ 
    }
    fBound.prototype = new fNOP(); // ç»§æ‰¿ä¸­é—´å‡½æ•°ï¼Œå…¶å®è¿™é‡Œä¹Ÿç»§æ‰¿äº†è°ƒç”¨è€…äº†

    return fBound; // new fn()
  };
})();
```

### new 

è¿™é‡Œåªå…³æ³¨å…¶ `this` æŒ‡å‘çš„é—®é¢˜

å®ç°

```js
// new å…³é”®å­—ä¼šè¿›è¡Œå¦‚ä¸‹çš„æ“ä½œï¼š

// 1. åˆ›å»ºä¸€ä¸ªç©ºçš„ç®€å•çš„ JavaScript å¯¹è±¡ï¼ˆå³ {}ï¼‰
// 2. é“¾æ¥è¯¥å¯¹è±¡ï¼ˆè®¾ç½®è¯¥å¯¹è±¡çš„ constructorï¼‰åˆ°å¦ä¸€ä¸ªå¯¹è±¡
// 3. å°†æ­¥éª¤ 1 æ–°åˆ›å»ºçš„å¯¹è±¡ä½œä¸º this çš„ä¸Šä¸‹æ–‡
// 4. å¦‚æœè¯¥å‡½æ•°æ²¡æœ‰è¿”å›å¯¹è±¡ï¼Œåˆ™è¿”å› this

// æ¨¡æ‹Ÿå®ç°ä¸€ä¸ª new â­

// new Fn()
// myNew(Fn, ...args)

import _ from 'lodash';

function myNew(fn, ...args) {
  // fn å¿…é¡»æ˜¯ä¸€ä¸ªå‡½æ•°
  if(typeof fn !== 'function') throw new Error('fn must be a function.')

  // es6 new.target
  myNew.target = fn;

  // åŸå‹ç»§æ‰¿
  const temp = Object.create(fn.prototype) // æ­¥éª¤ 1. 2.

  // fn æ‰§è¡Œç»‘å®š this ç¯å¢ƒ
  const res = fn.apply(temp, ...args) // æ­¥éª¤ 3.

  // å¦‚æœè¯¥å‡½æ•°æ²¡æœ‰è¿”å›å¯¹è±¡ï¼Œåˆ™è¿”å› this
  return _.isObject(res) ? res : temp
}
```

> å¦‚æœå‡½æ•° `constructor` é‡Œæ²¡æœ‰è¿”å›å¯¹è±¡çš„è¯ï¼Œ`this` æŒ‡å‘çš„æ˜¯ `new` ä¹‹åå¾—åˆ°çš„å®ä¾‹

```js
function foo(a) {
  this.a = a
}

const f = new foo(2)
f.a // console what?

// ------------------------- å˜ ---------------------------
function bar(a) {
  this.a = a
  return {
    a: 100
  }
}
const b = new bar(3)
b.a // console what ?
```


### ç®­å¤´å‡½æ•°

ç®­å¤´å‡½æ•°çš„æƒ…å†µæ¯”è¾ƒç‰¹æ®Šï¼Œç¼–è¯‘æœŸé—´ç¡®å®šçš„ä¸Šä¸‹æ–‡ï¼Œä¸ä¼šè¢«æ”¹å˜ï¼Œä¸ç®¡`new` æŒ‡å‘çš„æ˜¯å¦æ˜¯**ä¸Šä¸€å±‚**çš„ä¸Šä¸‹æ–‡

> ç®­å¤´å‡½æ•°æœ¬èº«æ˜¯æ²¡æœ‰ `this` çš„ï¼Œç»§æ‰¿çš„æ˜¯å¤–å±‚çš„ï¼Œåªå–å†³äºå¤–é¢çš„ç¬¬ä¸€ä¸ªä¸æ˜¯ç®­å¤´å‡½æ•°çš„å‡½æ•°çš„ this

â­
```js
function fn() {
  return {
    b: () => {
      console.log(this)
    }
  }
}

fn().b() // console what?
fn().b.bind(1)() // console what?
fn.bind(2)().b.bind(3)() // console what?



function a() {
  return () => {
    return () => {
      console.log(this)
    }
  }
}
console.log(a()()())
// è¿™ä¸ªä¾‹å­ä¸­ this æ˜¯ window ã€‚å¹¶ä¸” this â¼€æ—¦ç»‘å®šäº†ä¸Šä¸‹â½‚ï¼Œå°±ä¸ä¼šè¢«ä»»ä½•ä»£ç æ”¹å˜
```

### å­¦ä¹ 
[æ›´å¤šå¯å‚è§ MDN](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Operators/this)


### ä¼˜å…ˆçº§

> TIP ğŸ‘‰ ä¼˜å…ˆçº§ã€Œnew ç»‘ã€ > ã€Œæ˜¾ç»‘ã€ > ã€Œéšç»‘ã€ > ã€Œé»˜è®¤ç»‘å®šã€

â­
```js
// éšå¼ vs é»˜è®¤ -> ç»“è®ºï¼šéšå¼ > é»˜è®¤
function fn() {
  console.log('this', this)
}

const obj = {
  fn
}

obj.fn() // what ?

// æ˜¾å¼ vs éšå¼ -> ç»“è®ºï¼šæ˜¾å¼ > éšå¼
obj.fn.bind(5)() // what ?

// new vs æ˜¾å¼ -> ç»“è®ºï¼šnew > æ˜¾å¼
function foo (a) {
    this.a = a
}

const obj1 = {}

var bar = foo.bind(obj1)
bar(2)
console.log(obj1.a) // what ?

â­
// new
var baz = new bar(3)
console.log( obj1.a ) // what ?
console.log( baz.a ) // what ?

// ç®­å¤´å‡½æ•°æ²¡æœ‰ thisï¼Œæ¯”è¾ƒæ²¡æœ‰æ„ä¹‰
```

### å®æˆ˜


```js
// 1.
function foo() {
  console.log( this.a ) // console what
}
var a = 2;
(function(){
  "use strict" // è¿·æƒ‘å¤§å®¶çš„
  foo();
})();

// 2.
var name="the window"

var object={
  name:"My Object", 
  getName: function(){ 
    return this.name
  } 
}
object.getName() // console what ?
(object.getName)() // console what ?
(object.getName = object.getName)() // console what ?
(object.getName, object.getName)() // console what ?

// 3.
var x = 3
var obj3 = {
  x: 1,
  getX: function() {
    var x = 5
    return function() {
      return this.x
    }(); // âš ï¸
  }
}
console.log(obj3.getX()) // console what?

â­
// 4. 
function a(x){
  this.x = x
  return this
}
var x = a(5) // æ›¿æ¢ä¸º let å†è¯•è¯• this: {x: 5}
var y = a(6) // æ›¿æ¢ä¸º let å†è¯•è¯• // å†æ¢å› varï¼Œä½†æ˜¯å»æ‰ y çš„æƒ…å†µï¼Œå†è¯•è¯• x: 6

console.log(x.x) // console what ?
console.log(y.x) // console what ?

// ç­‰ä»·äº
window.x = 5;
window.x = window;

window.x = 6;
window.y = window;

console.log(x.x) // void 0 å…¶å®æ‰§è¡Œçš„æ˜¯ Number(6).x
console.log(y.x) // 6
```

### å®ä¾‹
```js
function foo() {
  console.log(this.a) 
}
var a = 1;
foo()

var obj = {
  a: 2,
  foo: foo
}

obj.foo()

// ä»¥ä¸Šä¸¤è€…æƒ…å†µ `this` åªä¾èµ–äºè°ƒâ½¤å‡½æ•°å‰çš„å¯¹è±¡ï¼Œä¼˜å…ˆçº§æ˜¯ç¬¬â¼†ä¸ªæƒ…å†µâ¼¤äºç¬¬â¼€ä¸ªæƒ…å†µ

// ä»¥ä¸‹æƒ…å†µæ˜¯ä¼˜å…ˆçº§æœ€â¾¼çš„ï¼Œ`this` åªä¼šç»‘å®šåœ¨ `c` ä¸Šï¼Œä¸ä¼šè¢«ä»»ä½•â½…å¼ä¿®æ”¹ `this` æŒ‡å‘
var c = new foo()
c.a = 3
console.log(c.a)

// è¿˜æœ‰ç§å°±æ˜¯åˆ©â½¤ callï¼Œapplyï¼Œbind æ”¹å˜ thisï¼Œè¿™ä¸ªä¼˜å…ˆçº§ä»…æ¬¡äº new
```


### ä½œä¸šï¼šå°è¯•ç€å»è¯»ä¸€è¯»ï¼Œç†è§£ä¸€ä¸‹

[this keyword](https://tc39.es/ecma262/#sec-this-keyword)

